#!/usr/bin/env bash

# Ignore this .local/bin directory when searching for nvim
export PATH=$(echo $PATH | sed -E -e "s|${HOME}/.local/bin(:\|$)||")

if command -v kitten &> /dev/null; then
  # If running in Kitty, get the tab id for a remote Neovim instance
  pipe="${XDG_CACHE_HOME:-${HOME}/.cache}/nvim/server-${KITTY_TAB_ID}.pipe"
  if [ -S "${pipe}" ]; then
    if [ "$1" = "-k" ] || [ "$1" = "--kitty-remote" ]; then
      shift
      # Open file in existing instance
      keys=""
      for arg in "$@"; do
        if [[ "$arg" =~ \+[0-9]+ ]]; then
          # Line number argument, MUST come after file
          keys+=":${arg#+}<CR>"
        else
          # Argument is filename
          keys+=":tabedit $arg<CR>"
        fi
      done
      nvim --server "${pipe}" --remote-send "${keys}"
    else
      # Launch new, non-remote instance
      nvim "$@"
    fi
  else
    # Launch instance if there isn't one already
    if [ "$1" = "-k" ] || [ "$1" = "--kitty-remote" ]; then
      shift
    fi
    nvim --listen "${pipe}" "$@"
  fi
else
  nvim "$@"
fi
